pipeline {
  agent {
    kubernetes {
      label 'jenkins-frontend'
      defaultContainer 'helm'
      namespace 'default'
      serviceAccount 'jenkins-deployer'
    }
  }

  environment {
    KUBECONFIG_PATH = '/home/jenkins/.kube/config'
    CHART_PATH = './charts/frontend-chart'
    NAMESPACE = 'jenkins-developer'
  }

  stages {
    stage('Deploy Frontend') {
      steps {

          sh '''
            echo "DEBUG: deploy frontend"
            KUBECONFIG=${KUBECONFIG_PATH} helm upgrade --install todo-frontend ${CHART_PATH} \
              -f ${CHART_PATH}/values.yaml \
              --namespace ${NAMESPACE} \
              --create-namespace \
              --wait
          '''

      }
    }

    stage('Verify') {
      steps {

          sh '''
            KUBECONFIG=${KUBECONFIG_PATH} kubectl get pods -n ${NAMESPACE} -l app=todo-frontend
            KUBECONFIG=${KUBECONFIG_PATH} kubectl get svc -n ${NAMESPACE} -l app=todo-frontend
          '''

      }
    }
  }

  post {
    failure {
      container('kubectl') {
        sh '''
          KUBECONFIG=${KUBECONFIG_PATH} kubectl logs -l app=todo-frontend -n ${NAMESPACE} --tail=50 || true
        '''
      }
    }
  }
}
