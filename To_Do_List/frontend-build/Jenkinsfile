pipeline {
    agent {
        kubernetes {
            inheritFrom 'jenkins-frontend-build'
            defaultContainer 'docker'
            namespace 'jenkins-developer'
            serviceAccount 'jenkins-deployer'
        }
    }

    environment {
        DOCKERHUB_USERNAME = 'inestmimi123'
        DOCKERHUB_IMAGE = 'todo-frontend'
        IMAGE_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
        DOCKER_BUILDKIT = '1'
        NODE_MODULES_PVC_PATH = '/mnt/node_modules_cache'
        DOCKER_CACHE_PVC_PATH = '/var/lib/docker'
        ARTIFACTS_PVC_PATH = '/artifacts'
        WORK_DIR = "${WORKSPACE}/To_Do_List"
    }

    stages {
        stage('Setup Node Modules Cache') {
            steps {
                container('node') {
                    script {
                        sh '''
                            if [ -d "${WORK_DIR}/node_modules" ] && [ ! -L "${WORK_DIR}/node_modules" ]; then
                                rm -rf "${WORK_DIR}/node_modules"
                            fi

                            mkdir -p "${NODE_MODULES_PVC_PATH}/cache"

                            if [ ! -L "${WORK_DIR}/node_modules" ]; then
                                ln -sf "${NODE_MODULES_PVC_PATH}/cache" "${WORK_DIR}/node_modules"
                            fi
                        '''
                    }
                }
            }
        }

        stage('Dependencies Installation') {
            steps {
            container('node') {
                script {
                    sh '''
                        cd "${WORK_DIR}"

                        if [ ! -f "package.json" ]; then
                            exit 1
                        fi

                        # On utilise directement le lien symbolique vers le PVC node_modules
                        if [ ! -L "node_modules" ]; then
                            rm -rf node_modules
                            ln -sf "${NODE_MODULES_PVC_PATH}/cache" node_modules
                        fi

                        npm ci

                        cp package-lock.json ${NODE_MODULES_PVC_PATH}/package-lock.json.bak || true
                    '''
                }
            }

            }
        }

        stage('Docker Login') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh 'echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin'
                }
            }
        }

        stage('Build Frontend Image') {
            steps {
                script {
                    sh '''
                        cd "${WORK_DIR}"

                        DOCKER_BUILDKIT=1 docker build \
                          --build-arg BUILDKIT_INLINE_CACHE=1 \
                          --cache-from ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:latest \
                          -t ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG} \
                          -t ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:latest \
                          .
                    '''
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                sh '''
                    docker push ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG}
                    docker push ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:latest
                '''
            }
        }

        stage('Docker Cleanup') {
            steps {
                sh '''
                    docker system prune -f --filter "until=24h"

                    docker images ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE} --format "table {{.Tag}}\t{{.CreatedAt}}" | \
                    tail -n +2 | sort -k2 -r | tail -n +4 | awk '{print $1}' | \
                    xargs -r -I {} docker rmi ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:{} || true
                '''
            }
        }
    }

    post {
        always {
            script {
                sh '''
                    echo "Build: ${BUILD_NUMBER}"
                    echo "Commit: ${GIT_COMMIT}"
                    echo "Image: ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG}"

                    df -h ${NODE_MODULES_PVC_PATH} || true
                    df -h ${ARTIFACTS_PVC_PATH} || true
                    df -h ${DOCKER_CACHE_PVC_PATH} || true
                '''
            }
        }
        success {
            echo "Build frontend réussi avec optimisation PVC complète"
            script {
                sh '''
                    echo "Artefacts disponibles dans: ${ARTIFACTS_PVC_PATH}/build-${BUILD_NUMBER}"
                    echo "Image Docker: ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG}"
                '''
            }
        }
        failure {
            echo "Échec du build frontend"
            script {
                sh '''
                    echo "Workspace: ${WORK_DIR}"
                    ls -la "${WORK_DIR}" || true
                    echo "Cache node_modules:"
                    ls -la "${NODE_MODULES_PVC_PATH}" || true
                '''
            }
        }
        cleanup {
            sh '''
                docker logout || true
            '''
        }
    }
}
