pipeline {
  agent {
    kubernetes {
      inheritFrom 'jenkins-backend-build'
      defaultContainer 'docker'
      namespace 'jenkins-developer'
      serviceAccount 'jenkins-deployer'
    }
  }

  environment {
    DOCKERHUB_USERNAME = 'inestmimi123'
    DOCKERHUB_IMAGE = 'todo-backend'
    IMAGE_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
    DOCKER_BUILDKIT = '1'
    WORKSPACE_PVC_PATH = '/mnt/workspace_cache'
    ARTIFACTS_PVC_PATH = '/mnt/artifacts'
  }

  stages {
    stage('Workspace info') {
      steps {
        container('node') {
          sh 'echo "Workspace is: $WORKSPACE" && ls -la $WORKSPACE && ls -la $WORKSPACE/To_Do_List_Backend'
        }
      }
    }

    stage('Dependencies Installation') {
      steps {
        container('node') {
          dir('To_Do_List_Backend') {
            sh '''
              echo "=== Installing dependencies using PVC-mounted node_modules ==="

              # Assure le dossier node_modules dans le PVC
              mkdir -p ${WORKSPACE_PVC_PATH}/node_modules

              # Crée lien symbolique local vers node_modules du PVC
              ln -sf ${WORKSPACE_PVC_PATH}/node_modules ./node_modules

              if [ -f package.json ]; then
                # Vérifie si des paquets sont obsolètes
                outdated=$(npm outdated --json || echo '{}')
                if [ "$(echo "$outdated" | jq length)" -gt 0 ]; then
                  echo "Outdated dependencies detected, reinstalling..."
                  rm -rf node_modules/*
                  npm ci
                elif [ ! -d node_modules ] || [ ! "$(ls -A node_modules)" ]; then
                  echo "No node_modules found, running npm ci..."
                  npm ci
                else
                  echo "node_modules cache is valid, skipping npm install"
                fi
              else
                echo "No package.json found, skipping npm install"
              fi
            '''
          }
        }
      }
    }

    stage('Docker Login') {
      steps {
        container('docker') {
          withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
            sh '''
              echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin
            '''
          }
        }
      }
    }

    stage('Build Backend Image') {
      steps {
        container('docker') {
          dir('To_Do_List_Backend') {
            sh '''
              echo "=== Building Docker image with BuildKit ==="
              DOCKER_BUILDKIT=1 docker build \
                --build-arg BUILDKIT_INLINE_CACHE=1 \
                --cache-from ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:latest \
                -t ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG} \
                -t ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:latest .
            '''
          }
        }
      }
    }

    stage('Push to Docker Hub') {
      steps {
        container('docker') {
          sh '''
            docker push ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG}
            docker push ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:latest
          '''
        }
      }
    }

    stage('Artifacts Persistence') {
      steps {
        container('node') {
          sh '''
            if [ -d "To_Do_List_Backend/dist" ]; then
              echo "Saving build artifacts to PVC..."
              mkdir -p ${ARTIFACTS_PVC_PATH}/build-${BUILD_NUMBER}
              cp -r To_Do_List_Backend/dist/* ${ARTIFACTS_PVC_PATH}/build-${BUILD_NUMBER}/
            else
              echo "No dist directory found, skipping artifact persistence"
            fi
          '''
        }
      }
    }

    stage('Cleanup Docker') {
      steps {
        container('docker') {
          sh '''
            docker system prune -f --filter "until=24h" || echo "Docker cleanup failed"
          '''
        }
      }
    }
  }

  post {
    always {
      echo "=== Pipeline completed ==="
    }
    success {
      echo "Backend image built and pushed successfully!"
    }
    failure {
      echo "Backend pipeline failed."
    }
  }
}
